{"ast":null,"code":"import _objectSpread from\"C:/Users/torre/Documents/neuromap.app/src/main/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"C:/Users/torre/Documents/neuromap.app/src/main/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import React,{useCallback,useContext,useState,useRef,useEffect}from\"react\";import{IdeaContext}from\"./IdeaContext\";import{ThemeContext}from\"./ThemeContext\";import{useDrop}from\"react-dnd\";import{Idea}from\"./Idea\";import{ItemTypes}from\"./ItemTypes\";import{v4 as uuidv4}from\"uuid\";import Modal from\"./Modal\";import IdeaForm from\"./IdeaForm\";import update from\"immutability-helper\";import Arrow from\"./Arrow\";import\"./FreeFormIdeas.css\";/**\r\n * Calculates the coordinates of the end of arrow, pointing to the idea\r\n *\r\n * @param {{ height: number, width: number, top: number, left: number }} idea The idea the arrow is pointing to/from\r\n * @param {number} arrowRotation The rotation of the arrow (in degrees) in the range (-180, 180]\r\n * @returns {[number, number]} The coordinates ([top, left]) of the end of the arrow\r\n */export function calcCoords(idea,arrowRotation){var height=idea.height,width=idea.width,ideaTop=idea.top,ideaLeft=idea.left;var posArrowRotation=Math.abs(arrowRotation);var referenceAngleOne=180/Math.PI*Math.atan2(height,width);var referenceAngleTwo=180-referenceAngleOne;var top,left;if(posArrowRotation>referenceAngleOne&&posArrowRotation<referenceAngleTwo){top=ideaTop+(arrowRotation<0?0:height);left=ideaLeft+width/2+height/2*Math.tan((90-posArrowRotation)*Math.PI/180);}else{var isOnRight=posArrowRotation<=referenceAngleOne;top=ideaTop+height/2+width/2*Math.tan((isOnRight?arrowRotation:180-arrowRotation)*Math.PI/180);left=ideaLeft+(isOnRight?width:0);}return[top,left].map(Math.round);}var FreeFormIdeas=function FreeFormIdeas(){var _useContext=useContext(ThemeContext),theme=_useContext.theme;var _useContext2=useContext(IdeaContext),ideas=_useContext2.ideas,ideasDispatch=_useContext2.ideasDispatch,selectedId=_useContext2.selectedId,setSelectedId=_useContext2.setSelectedId;var selectedIdea=ideas[selectedId];var _useState=useState({top:0,left:0}),_useState2=_slicedToArray(_useState,2),coords=_useState2[0],setCoords=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),showIdeaModal=_useState4[0],setShowIdeaModal=_useState4[1];var ideaModalShow=useCallback(function(){return setShowIdeaModal(true);},[]);var ideaModalHide=useCallback(function(){return setShowIdeaModal(false);},[]);var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),linkerEnd=_useState6[0],setLinkerEnd=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),linkingState=_useState8[0],setLinkingState=_useState8[1];var linkBreak=useCallback(function(){return setLinkingState(false);},[]);var domElement=useRef();var _useState9=useState(60),_useState10=_slicedToArray(_useState9,2),canvasOffset=_useState10[0],setcanvasOffset=_useState10[1];var updateCanvasOffset=function updateCanvasOffset(){setcanvasOffset(domElement.current.getBoundingClientRect().y);};var handleLinkStart=useCallback(function(e){setLinkerEnd([e.clientY-canvasOffset,e.clientX]);setLinkingState(true);},[canvasOffset]);var adjustLinker=useCallback(function(e){if(!linkingState)return;setLinkerEnd([e.clientY-canvasOffset,e.clientX]);},[linkingState,canvasOffset]);var handleLinkEnd=useCallback(function(id){setLinkingState(false);if(id===selectedId||!linkingState)return;ideasDispatch({type:\"link\",fromId:selectedId,toId:id});},[selectedId,linkingState,ideasDispatch]);var _useDrop=useDrop({accept:ItemTypes.IDEA,drop:function drop(item,monitor){var delta=monitor.getDifferenceFromInitialOffset();var left=Math.round(item.left+delta.x);var top=Math.round(item.top+delta.y);ideasDispatch({type:\"update\",id:item.id,data:{left:left,top:top}});}}),_useDrop2=_slicedToArray(_useDrop,2),drop=_useDrop2[1];var editIdea=useCallback(function(id){setSelectedId(id);ideaModalShow(true);},[ideaModalShow,setSelectedId]);var handleDoubleClick=useCallback(function(e){if(e.target.className!==\"FreeFormIdeas\")return;e.preventDefault();setCoords({top:e.clientY-canvasOffset,left:e.clientX});setSelectedId(uuidv4());setTimeout(ideaModalShow,300);},[ideaModalShow,setSelectedId,canvasOffset]);var handleIdeaChange=useCallback(function(idea){ideaModalHide();if(idea.title===\"\")return;if(!idea.id){ideasDispatch({type:\"create\",id:selectedId,data:update(idea,{$merge:coords})});return;}ideasDispatch({type:\"update\",id:selectedId,data:idea});},[coords,selectedId,ideasDispatch,ideaModalHide]);var domElementRef=useCallback(function(domElementReference){domElement.current=domElementReference;updateCanvasOffset();drop(domElementReference);},[drop]);useEffect(function(){window.addEventListener(\"resize\",updateCanvasOffset);return function(){window.removeEventListener(\"resize\",updateCanvasOffset);};},[]);return/*#__PURE__*/_jsxs(\"div\",{ref:domElementRef,className:\"FreeFormIdeas\",style:{background:theme.freeFormIdeasColor},onDoubleClick:handleDoubleClick,onMouseUp:linkBreak,onMouseMove:adjustLinker,children:[showIdeaModal&&/*#__PURE__*/_jsx(Modal,{onClose:ideaModalHide,children:/*#__PURE__*/_jsx(IdeaForm,{onSubmit:handleIdeaChange,idea:selectedIdea})}),Object.entries(ideas).map(function(_ref){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],idea=_ref2[1];return/*#__PURE__*/_jsx(Idea,_objectSpread({onEdit:editIdea,onSelect:setSelectedId,selected:idea.id===selectedId,onLinkStart:handleLinkStart,onLinkEnd:handleLinkEnd},idea),key);}),Array.from((selectedIdea===null||selectedIdea===void 0?void 0:selectedIdea.linkList)||[],function(endId){var arrowHeight=ideas[endId].top+ideas[endId].height/2-(selectedIdea.top+selectedIdea.height/2);var arrowWidth=ideas[endId].left+ideas[endId].width/2-(selectedIdea.left+selectedIdea.width/2);var arrowRotationStart=180/Math.PI*Math.atan2(arrowHeight,arrowWidth);var arrowRotationEnd=arrowRotationStart-180*Math.sign(arrowRotationStart);return/*#__PURE__*/_jsx(Arrow,{start:calcCoords(selectedIdea,arrowRotationStart),end:calcCoords(ideas[endId],arrowRotationEnd)},\"\".concat(selectedId,\" -> \").concat(endId));}),linkingState&&/*#__PURE__*/_jsx(\"div\",{className:\"linkingArrow\",children:/*#__PURE__*/_jsx(Arrow,{start:[selectedIdea.top,selectedIdea.left],end:linkerEnd})})]});};export default FreeFormIdeas;","map":{"version":3,"sources":["C:/Users/torre/Documents/neuromap.app/src/main/frontend/src/FreeformIdeas.js"],"names":["React","useCallback","useContext","useState","useRef","useEffect","IdeaContext","ThemeContext","useDrop","Idea","ItemTypes","v4","uuidv4","Modal","IdeaForm","update","Arrow","calcCoords","idea","arrowRotation","height","width","ideaTop","top","ideaLeft","left","posArrowRotation","Math","abs","referenceAngleOne","PI","atan2","referenceAngleTwo","tan","isOnRight","map","round","FreeFormIdeas","theme","ideas","ideasDispatch","selectedId","setSelectedId","selectedIdea","coords","setCoords","showIdeaModal","setShowIdeaModal","ideaModalShow","ideaModalHide","linkerEnd","setLinkerEnd","linkingState","setLinkingState","linkBreak","domElement","canvasOffset","setcanvasOffset","updateCanvasOffset","current","getBoundingClientRect","y","handleLinkStart","e","clientY","clientX","adjustLinker","handleLinkEnd","id","type","fromId","toId","accept","IDEA","drop","item","monitor","delta","getDifferenceFromInitialOffset","x","data","editIdea","handleDoubleClick","target","className","preventDefault","setTimeout","handleIdeaChange","title","$merge","domElementRef","domElementReference","window","addEventListener","removeEventListener","background","freeFormIdeasColor","Object","entries","key","Array","from","linkList","endId","arrowHeight","arrowWidth","arrowRotationStart","arrowRotationEnd","sign"],"mappings":"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","sourcesContent":["import React, {\r\n  useCallback,\r\n  useContext,\r\n  useState,\r\n  useRef,\r\n  useEffect,\r\n} from \"react\";\r\nimport { IdeaContext } from \"./IdeaContext\";\r\nimport { ThemeContext } from \"./ThemeContext\";\r\nimport { useDrop } from \"react-dnd\";\r\nimport { Idea } from \"./Idea\";\r\nimport { ItemTypes } from \"./ItemTypes\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport Modal from \"./Modal\";\r\nimport IdeaForm from \"./IdeaForm\";\r\nimport update from \"immutability-helper\";\r\nimport Arrow from \"./Arrow\";\r\nimport \"./FreeFormIdeas.css\";\r\n\r\n/**\r\n * Calculates the coordinates of the end of arrow, pointing to the idea\r\n *\r\n * @param {{ height: number, width: number, top: number, left: number }} idea The idea the arrow is pointing to/from\r\n * @param {number} arrowRotation The rotation of the arrow (in degrees) in the range (-180, 180]\r\n * @returns {[number, number]} The coordinates ([top, left]) of the end of the arrow\r\n */\r\nexport function calcCoords(idea, arrowRotation) {\r\n  const { height, width, top: ideaTop, left: ideaLeft } = idea;\r\n  const posArrowRotation = Math.abs(arrowRotation);\r\n  const referenceAngleOne = (180 / Math.PI) * Math.atan2(height, width);\r\n  const referenceAngleTwo = 180 - referenceAngleOne;\r\n  let top, left;\r\n\r\n  if (\r\n    posArrowRotation > referenceAngleOne &&\r\n    posArrowRotation < referenceAngleTwo\r\n  ) {\r\n    top = ideaTop + (arrowRotation < 0 ? 0 : height);\r\n    left =\r\n      ideaLeft +\r\n      width / 2 +\r\n      (height / 2) * Math.tan(((90 - posArrowRotation) * Math.PI) / 180);\r\n  } else {\r\n    const isOnRight = posArrowRotation <= referenceAngleOne;\r\n\r\n    top =\r\n      ideaTop +\r\n      height / 2 +\r\n      (width / 2) *\r\n        Math.tan(\r\n          ((isOnRight ? arrowRotation : 180 - arrowRotation) * Math.PI) / 180\r\n        );\r\n    left = ideaLeft + (isOnRight ? width : 0);\r\n  }\r\n  return [top, left].map(Math.round);\r\n}\r\n\r\nconst FreeFormIdeas = () => {\r\n  const { theme } = useContext(ThemeContext);\r\n\r\n  const { ideas, ideasDispatch, selectedId, setSelectedId } = useContext(\r\n    IdeaContext\r\n  );\r\n  const selectedIdea = ideas[selectedId];\r\n\r\n  const [coords, setCoords] = useState({ top: 0, left: 0 });\r\n\r\n  const [showIdeaModal, setShowIdeaModal] = useState(false);\r\n  const ideaModalShow = useCallback(() => setShowIdeaModal(true), []);\r\n  const ideaModalHide = useCallback(() => setShowIdeaModal(false), []);\r\n\r\n  const [linkerEnd, setLinkerEnd] = useState();\r\n  const [linkingState, setLinkingState] = useState(false);\r\n  const linkBreak = useCallback(() => setLinkingState(false), []);\r\n\r\n  const domElement = useRef();\r\n  const [canvasOffset, setcanvasOffset] = useState(60);\r\n  const updateCanvasOffset = () => {\r\n    setcanvasOffset(domElement.current.getBoundingClientRect().y);\r\n  };\r\n\r\n  const handleLinkStart = useCallback(\r\n    (e) => {\r\n      setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\r\n      setLinkingState(true);\r\n    },\r\n    [canvasOffset]\r\n  );\r\n\r\n  const adjustLinker = useCallback(\r\n    (e) => {\r\n      if (!linkingState) return;\r\n      setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\r\n    },\r\n    [linkingState, canvasOffset]\r\n  );\r\n\r\n  const handleLinkEnd = useCallback(\r\n    (id) => {\r\n      setLinkingState(false);\r\n      if (id === selectedId || !linkingState) return;\r\n      ideasDispatch({ type: \"link\", fromId: selectedId, toId: id });\r\n    },\r\n    [selectedId, linkingState, ideasDispatch]\r\n  );\r\n\r\n  const [, drop] = useDrop({\r\n    accept: ItemTypes.IDEA,\r\n    drop(item, monitor) {\r\n      const delta = monitor.getDifferenceFromInitialOffset();\r\n      const left = Math.round(item.left + delta.x);\r\n      const top = Math.round(item.top + delta.y);\r\n      ideasDispatch({\r\n        type: \"update\",\r\n        id: item.id,\r\n        data: { left, top },\r\n      });\r\n    },\r\n  });\r\n\r\n  const editIdea = useCallback(\r\n    (id) => {\r\n      setSelectedId(id);\r\n      ideaModalShow(true);\r\n    },\r\n    [ideaModalShow, setSelectedId]\r\n  );\r\n\r\n  const handleDoubleClick = useCallback(\r\n    (e) => {\r\n      if (e.target.className !== \"FreeFormIdeas\") return;\r\n      e.preventDefault();\r\n      setCoords({ top: e.clientY - canvasOffset, left: e.clientX });\r\n\r\n      setSelectedId(uuidv4());\r\n      setTimeout(ideaModalShow, 300);\r\n    },\r\n    [ideaModalShow, setSelectedId, canvasOffset]\r\n  );\r\n\r\n  const handleIdeaChange = useCallback(\r\n    (idea) => {\r\n      ideaModalHide();\r\n      if (idea.title === \"\") return;\r\n      if (!idea.id) {\r\n        ideasDispatch({\r\n          type: \"create\",\r\n          id: selectedId,\r\n          data: update(idea, { $merge: coords }),\r\n        });\r\n        return;\r\n      }\r\n      ideasDispatch({ type: \"update\", id: selectedId, data: idea });\r\n    },\r\n    [coords, selectedId, ideasDispatch, ideaModalHide]\r\n  );\r\n\r\n  const domElementRef = useCallback(\r\n    (domElementReference) => {\r\n      domElement.current = domElementReference;\r\n      updateCanvasOffset();\r\n      drop(domElementReference);\r\n    },\r\n    [drop]\r\n  );\r\n\r\n  useEffect(() => {\r\n    window.addEventListener(\"resize\", updateCanvasOffset);\r\n    return () => {\r\n      window.removeEventListener(\"resize\", updateCanvasOffset);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      ref={domElementRef}\r\n      className=\"FreeFormIdeas\"\r\n      style={{ background: theme.freeFormIdeasColor }}\r\n      onDoubleClick={handleDoubleClick}\r\n      onMouseUp={linkBreak}\r\n      onMouseMove={adjustLinker}\r\n    >\r\n      {showIdeaModal && (\r\n        <Modal onClose={ideaModalHide}>\r\n          <IdeaForm onSubmit={handleIdeaChange} idea={selectedIdea} />\r\n        </Modal>\r\n      )}\r\n      {Object.entries(ideas).map(([key, idea]) => (\r\n        <Idea\r\n          key={key}\r\n          onEdit={editIdea}\r\n          onSelect={setSelectedId}\r\n          selected={idea.id === selectedId}\r\n          onLinkStart={handleLinkStart}\r\n          onLinkEnd={handleLinkEnd}\r\n          {...idea}\r\n        />\r\n      ))}\r\n      {Array.from(selectedIdea?.linkList || [], (endId) => {\r\n        const arrowHeight =\r\n          ideas[endId].top +\r\n          ideas[endId].height / 2 -\r\n          (selectedIdea.top + selectedIdea.height / 2);\r\n        const arrowWidth =\r\n          ideas[endId].left +\r\n          ideas[endId].width / 2 -\r\n          (selectedIdea.left + selectedIdea.width / 2);\r\n        const arrowRotationStart =\r\n          (180 / Math.PI) * Math.atan2(arrowHeight, arrowWidth);\r\n        const arrowRotationEnd =\r\n          arrowRotationStart - 180 * Math.sign(arrowRotationStart);\r\n        return (\r\n          <Arrow\r\n            key={`${selectedId} -> ${endId}`}\r\n            start={calcCoords(selectedIdea, arrowRotationStart)}\r\n            end={calcCoords(ideas[endId], arrowRotationEnd)}\r\n          />\r\n        );\r\n      })}\r\n      {linkingState && (\r\n        <div className=\"linkingArrow\">\r\n          <Arrow\r\n            start={[selectedIdea.top, selectedIdea.left]}\r\n            end={linkerEnd}\r\n          />\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default FreeFormIdeas;\r\n"]},"metadata":{},"sourceType":"module"}