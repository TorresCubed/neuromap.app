{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"C:\\\\Users\\\\torre\\\\Documents\\\\neuromap.app\\\\src\\\\main\\\\frontend\\\\src\\\\FreeformIdeas.js\",\n    _s = $RefreshSig$();\n\nimport React, { useCallback, useContext, useState, useRef, useEffect } from \"react\";\nimport { IdeaContext } from \"./IdeaContext\";\nimport { ThemeContext } from \"./ThemeContext\";\nimport { useDrop } from \"react-dnd\";\nimport { Idea } from \"./Idea\";\nimport { ItemTypes } from \"./ItemTypes\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport Modal from \"./Modal\";\nimport IdeaForm from \"./IdeaForm\";\nimport update from \"immutability-helper\";\nimport Arrow from \"./Arrow\";\nimport \"./FreeFormIdeas.css\";\n/**\r\n * Calculates the coordinates of the end of arrow, pointing to the idea\r\n *\r\n * @param {{ height: number, width: number, top: number, left: number }} idea The idea the arrow is pointing to/from\r\n * @param {number} arrowRotation The rotation of the arrow (in degrees) in the range (-180, 180]\r\n * @returns {[number, number]} The coordinates ([top, left]) of the end of the arrow\r\n */\n\nexport function calcCoords(idea, arrowRotation) {\n  const {\n    height,\n    width,\n    top: ideaTop,\n    left: ideaLeft\n  } = idea;\n  const posArrowRotation = Math.abs(arrowRotation);\n  const referenceAngleOne = 180 / Math.PI * Math.atan2(height, width);\n  const referenceAngleTwo = 180 - referenceAngleOne;\n  let top, left;\n\n  if (posArrowRotation > referenceAngleOne && posArrowRotation < referenceAngleTwo) {\n    top = ideaTop + (arrowRotation < 0 ? 0 : height);\n    left = ideaLeft + width / 2 + height / 2 * Math.tan((90 - posArrowRotation) * Math.PI / 180);\n  } else {\n    const isOnRight = posArrowRotation <= referenceAngleOne;\n    top = ideaTop + height / 2 + width / 2 * Math.tan((isOnRight ? arrowRotation : 180 - arrowRotation) * Math.PI / 180);\n    left = ideaLeft + (isOnRight ? width : 0);\n  }\n\n  return [top, left].map(Math.round);\n}\n\nconst FreeFormIdeas = () => {\n  _s();\n\n  const {\n    theme\n  } = useContext(ThemeContext);\n  const {\n    ideas,\n    ideasDispatch,\n    selectedId,\n    setSelectedId\n  } = useContext(IdeaContext);\n  const selectedIdea = selectedId in ideas ? ideas[selectedId] : undefined;\n  const [coords, setCoords] = useState({\n    top: 0,\n    left: 0\n  });\n  const [showIdeaModal, setShowIdeaModal] = useState(false);\n  const ideaModalShow = useCallback(() => setShowIdeaModal(true), []);\n  const ideaModalHide = useCallback(() => setShowIdeaModal(false), []);\n  const [linkerEnd, setLinkerEnd] = useState();\n  const [linkingState, setLinkingState] = useState(false);\n  const linkBreak = useCallback(() => setLinkingState(false), []);\n  const domElement = useRef();\n  const [canvasOffset, setcanvasOffset] = useState(60);\n\n  const updateCanvasOffset = () => {\n    setcanvasOffset(domElement.current.getBoundingClientRect().y);\n  };\n\n  const handleLinkStart = useCallback(e => {\n    setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\n    setLinkingState(true);\n  }, [canvasOffset]);\n  const adjustLinker = useCallback(e => {\n    if (!linkingState) return;\n    setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\n  }, [linkingState, canvasOffset]);\n  const handleLinkEnd = useCallback(id => {\n    setLinkingState(false);\n    if (id === selectedId || !linkingState) return;\n    ideasDispatch({\n      type: \"link\",\n      fromId: selectedId,\n      toId: id\n    });\n  }, [selectedId, linkingState, ideasDispatch]);\n  const [, drop] = useDrop({\n    accept: ItemTypes.IDEA,\n\n    drop(item, monitor) {\n      const delta = monitor.getDifferenceFromInitialOffset();\n      const left = Math.round(item.left + delta.x);\n      const top = Math.round(item.top + delta.y);\n      ideasDispatch({\n        type: \"update\",\n        id: item.id,\n        data: {\n          left,\n          top\n        }\n      });\n    }\n\n  });\n  const editIdea = useCallback(id => {\n    setSelectedId(id);\n    ideaModalShow(true);\n  }, [ideaModalShow, setSelectedId]);\n  const handleDoubleClick = useCallback(e => {\n    if (e.target.className !== \"FreeFormIdeas\") return;\n    e.preventDefault();\n    setCoords({\n      top: e.clientY - canvasOffset,\n      left: e.clientX\n    });\n    console.log(ideas);\n    setSelectedId(uuidv4());\n    setTimeout(ideaModalShow, 300);\n  }, [ideaModalShow, setSelectedId, canvasOffset, ideas]);\n  const handleIdeaChange = useCallback(idea => {\n    ideaModalHide();\n    if (idea.content === \"\") return;\n\n    if (!idea.id) {\n      ideasDispatch({\n        type: \"create\",\n        id: selectedId,\n        data: update(idea, {\n          $merge: coords\n        })\n      });\n      return;\n    }\n\n    ideasDispatch({\n      type: \"update\",\n      id: selectedId,\n      data: idea\n    });\n  }, [coords, selectedId, ideasDispatch, ideaModalHide]);\n  const domElementRef = useCallback(domElementReference => {\n    domElement.current = domElementReference;\n    updateCanvasOffset();\n    drop(domElementReference);\n  }, [drop]);\n  useEffect(() => {\n    window.addEventListener(\"resize\", updateCanvasOffset);\n    return () => {\n      window.removeEventListener(\"resize\", updateCanvasOffset);\n    };\n  }, []);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    ref: domElementRef,\n    className: \"FreeFormIdeas\",\n    style: {\n      background: theme.freeFormIdeasColor\n    },\n    onDoubleClick: handleDoubleClick,\n    onMouseUp: linkBreak,\n    onMouseMove: adjustLinker,\n    children: [showIdeaModal && /*#__PURE__*/_jsxDEV(Modal, {\n      onClose: ideaModalHide,\n      children: /*#__PURE__*/_jsxDEV(IdeaForm, {\n        onSubmit: handleIdeaChange,\n        idea: selectedIdea\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 185,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 9\n    }, this), Object.entries(ideas).map(([key, idea]) => /*#__PURE__*/_jsxDEV(Idea, {\n      onEdit: editIdea,\n      onSelect: setSelectedId,\n      selected: idea.id === selectedId,\n      onLinkStart: handleLinkStart,\n      onLinkEnd: handleLinkEnd,\n      ...idea\n    }, key, false, {\n      fileName: _jsxFileName,\n      lineNumber: 189,\n      columnNumber: 9\n    }, this)), Array.from((selectedIdea === null || selectedIdea === void 0 ? void 0 : selectedIdea.linkList) || [], endId => {\n      const arrowHeight = ideas[endId].top + ideas[endId].height / 2 - (selectedIdea.top + selectedIdea.height / 2);\n      const arrowWidth = ideas[endId].left + ideas[endId].width / 2 - (selectedIdea.left + selectedIdea.width / 2);\n      const arrowRotationStart = 180 / Math.PI * Math.atan2(arrowHeight, arrowWidth);\n      const arrowRotationEnd = arrowRotationStart - 180 * Math.sign(arrowRotationStart);\n      return /*#__PURE__*/_jsxDEV(Arrow, {\n        start: calcCoords(selectedIdea, arrowRotationStart),\n        end: calcCoords(ideas[endId], arrowRotationEnd)\n      }, `${selectedId} -> ${endId}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 213,\n        columnNumber: 11\n      }, this);\n    }), linkingState && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"linkingArrow\",\n      children: /*#__PURE__*/_jsxDEV(Arrow, {\n        start: [selectedIdea.top, selectedIdea.left],\n        end: linkerEnd\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 222,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 221,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 175,\n    columnNumber: 5\n  }, this);\n};\n\n_s(FreeFormIdeas, \"aTVoMdUkU6UGh6u7Ta+Wl9eWkB0=\", false, function () {\n  return [useDrop];\n});\n\n_c = FreeFormIdeas;\nexport default FreeFormIdeas;\n\nvar _c;\n\n$RefreshReg$(_c, \"FreeFormIdeas\");","map":{"version":3,"sources":["C:/Users/torre/Documents/neuromap.app/src/main/frontend/src/FreeformIdeas.js"],"names":["React","useCallback","useContext","useState","useRef","useEffect","IdeaContext","ThemeContext","useDrop","Idea","ItemTypes","v4","uuidv4","Modal","IdeaForm","update","Arrow","calcCoords","idea","arrowRotation","height","width","top","ideaTop","left","ideaLeft","posArrowRotation","Math","abs","referenceAngleOne","PI","atan2","referenceAngleTwo","tan","isOnRight","map","round","FreeFormIdeas","theme","ideas","ideasDispatch","selectedId","setSelectedId","selectedIdea","undefined","coords","setCoords","showIdeaModal","setShowIdeaModal","ideaModalShow","ideaModalHide","linkerEnd","setLinkerEnd","linkingState","setLinkingState","linkBreak","domElement","canvasOffset","setcanvasOffset","updateCanvasOffset","current","getBoundingClientRect","y","handleLinkStart","e","clientY","clientX","adjustLinker","handleLinkEnd","id","type","fromId","toId","drop","accept","IDEA","item","monitor","delta","getDifferenceFromInitialOffset","x","data","editIdea","handleDoubleClick","target","className","preventDefault","console","log","setTimeout","handleIdeaChange","content","$merge","domElementRef","domElementReference","window","addEventListener","removeEventListener","background","freeFormIdeasColor","Object","entries","key","Array","from","linkList","endId","arrowHeight","arrowWidth","arrowRotationStart","arrowRotationEnd","sign"],"mappings":"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","sourcesContent":["import React, {\r\n  useCallback,\r\n  useContext,\r\n  useState,\r\n  useRef,\r\n  useEffect,\r\n} from \"react\";\r\nimport { IdeaContext } from \"./IdeaContext\";\r\nimport { ThemeContext } from \"./ThemeContext\";\r\nimport { useDrop } from \"react-dnd\";\r\nimport { Idea } from \"./Idea\";\r\nimport { ItemTypes } from \"./ItemTypes\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport Modal from \"./Modal\";\r\nimport IdeaForm from \"./IdeaForm\";\r\nimport update from \"immutability-helper\";\r\nimport Arrow from \"./Arrow\";\r\nimport \"./FreeFormIdeas.css\";\r\n\r\n/**\r\n * Calculates the coordinates of the end of arrow, pointing to the idea\r\n *\r\n * @param {{ height: number, width: number, top: number, left: number }} idea The idea the arrow is pointing to/from\r\n * @param {number} arrowRotation The rotation of the arrow (in degrees) in the range (-180, 180]\r\n * @returns {[number, number]} The coordinates ([top, left]) of the end of the arrow\r\n */\r\nexport function calcCoords(idea, arrowRotation) {\r\n  const { height, width, top: ideaTop, left: ideaLeft } = idea;\r\n  const posArrowRotation = Math.abs(arrowRotation);\r\n  const referenceAngleOne = (180 / Math.PI) * Math.atan2(height, width);\r\n  const referenceAngleTwo = 180 - referenceAngleOne;\r\n  let top, left;\r\n\r\n  if (\r\n    posArrowRotation > referenceAngleOne &&\r\n    posArrowRotation < referenceAngleTwo\r\n  ) {\r\n    top = ideaTop + (arrowRotation < 0 ? 0 : height);\r\n    left =\r\n      ideaLeft +\r\n      width / 2 +\r\n      (height / 2) * Math.tan(((90 - posArrowRotation) * Math.PI) / 180);\r\n  } else {\r\n    const isOnRight = posArrowRotation <= referenceAngleOne;\r\n\r\n    top =\r\n      ideaTop +\r\n      height / 2 +\r\n      (width / 2) *\r\n        Math.tan(\r\n          ((isOnRight ? arrowRotation : 180 - arrowRotation) * Math.PI) / 180\r\n        );\r\n    left = ideaLeft + (isOnRight ? width : 0);\r\n  }\r\n  return [top, left].map(Math.round);\r\n}\r\n\r\nconst FreeFormIdeas = () => {\r\n  const { theme } = useContext(ThemeContext);\r\n\r\n  const { ideas, ideasDispatch, selectedId, setSelectedId } = useContext(\r\n    IdeaContext\r\n  );\r\n  const selectedIdea = (selectedId in ideas) ? ideas[selectedId]: undefined;\r\n\r\n  const [coords, setCoords] = useState({ top: 0, left: 0 });\r\n\r\n  const [showIdeaModal, setShowIdeaModal] = useState(false);\r\n  const ideaModalShow = useCallback(() => setShowIdeaModal(true), []);\r\n  const ideaModalHide = useCallback(() => setShowIdeaModal(false), []);\r\n\r\n  const [linkerEnd, setLinkerEnd] = useState();\r\n  const [linkingState, setLinkingState] = useState(false);\r\n  const linkBreak = useCallback(() => setLinkingState(false), []);\r\n\r\n  const domElement = useRef();\r\n  const [canvasOffset, setcanvasOffset] = useState(60);\r\n  const updateCanvasOffset = () => {\r\n    setcanvasOffset(domElement.current.getBoundingClientRect().y);\r\n  };\r\n\r\n  const handleLinkStart = useCallback(\r\n    (e) => {\r\n      setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\r\n      setLinkingState(true);\r\n    },\r\n    [canvasOffset]\r\n  );\r\n\r\n  const adjustLinker = useCallback(\r\n    (e) => {\r\n      if (!linkingState) return;\r\n      setLinkerEnd([e.clientY - canvasOffset, e.clientX]);\r\n    },\r\n    [linkingState, canvasOffset]\r\n  );\r\n\r\n  const handleLinkEnd = useCallback(\r\n    (id) => {\r\n      setLinkingState(false);\r\n      if (id === selectedId || !linkingState) return;\r\n      ideasDispatch({ type: \"link\", fromId: selectedId, toId: id });\r\n    },\r\n    [selectedId, linkingState, ideasDispatch]\r\n  );\r\n\r\n  const [, drop] = useDrop({\r\n    accept: ItemTypes.IDEA,\r\n    drop(item, monitor) {\r\n      const delta = monitor.getDifferenceFromInitialOffset();\r\n      const left = Math.round(item.left + delta.x);\r\n      const top = Math.round(item.top + delta.y);\r\n      ideasDispatch({\r\n        type: \"update\",\r\n        id: item.id,\r\n        data: { left, top },\r\n      });\r\n    },\r\n  });\r\n\r\n  const editIdea = useCallback(\r\n    (id) => {\r\n      setSelectedId(id);\r\n      ideaModalShow(true);\r\n    },\r\n    [ideaModalShow, setSelectedId]\r\n  );\r\n\r\n  const handleDoubleClick = useCallback(\r\n    (e) => {\r\n      if (e.target.className !== \"FreeFormIdeas\") return;\r\n      e.preventDefault();\r\n      setCoords({ top: e.clientY - canvasOffset, left: e.clientX });\r\n      console.log(ideas)\r\n      setSelectedId(uuidv4());\r\n      setTimeout(ideaModalShow, 300);\r\n    },\r\n    [ideaModalShow, setSelectedId, canvasOffset, ideas]\r\n  );\r\n\r\n  const handleIdeaChange = useCallback(\r\n    (idea) => {\r\n      ideaModalHide();\r\n      if (idea.content === \"\") return;\r\n      if (!idea.id) {\r\n        ideasDispatch({\r\n          type: \"create\",\r\n          id: selectedId,\r\n          data: update(idea, { $merge: coords }),\r\n        });\r\n        return;\r\n      }\r\n      ideasDispatch({ type: \"update\", id: selectedId, data: idea });\r\n    },\r\n    [coords, selectedId, ideasDispatch, ideaModalHide]\r\n  );\r\n\r\n  const domElementRef = useCallback(\r\n    (domElementReference) => {\r\n      domElement.current = domElementReference;\r\n      updateCanvasOffset();\r\n      drop(domElementReference);\r\n    },\r\n    [drop]\r\n  );\r\n\r\n  useEffect(() => {\r\n    window.addEventListener(\"resize\", updateCanvasOffset);\r\n    return () => {\r\n      window.removeEventListener(\"resize\", updateCanvasOffset);\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      ref={domElementRef}\r\n      className=\"FreeFormIdeas\"\r\n      style={{ background: theme.freeFormIdeasColor }}\r\n      onDoubleClick={handleDoubleClick}\r\n      onMouseUp={linkBreak}\r\n      onMouseMove={adjustLinker}\r\n    >\r\n      {showIdeaModal && (\r\n        <Modal onClose={ideaModalHide}>\r\n          <IdeaForm onSubmit={handleIdeaChange} idea={selectedIdea} />\r\n        </Modal>\r\n      )}\r\n      {Object.entries(ideas).map(([key, idea]) => (\r\n        <Idea\r\n          key={key}\r\n          onEdit={editIdea}\r\n          onSelect={setSelectedId}\r\n          selected={idea.id === selectedId}\r\n          onLinkStart={handleLinkStart}\r\n          onLinkEnd={handleLinkEnd}\r\n          {...idea}\r\n        />\r\n      ))}\r\n      {Array.from(selectedIdea?.linkList || [], (endId) => {\r\n        const arrowHeight =\r\n          ideas[endId].top +\r\n          ideas[endId].height / 2 -\r\n          (selectedIdea.top + selectedIdea.height / 2);\r\n        const arrowWidth =\r\n          ideas[endId].left +\r\n          ideas[endId].width / 2 -\r\n          (selectedIdea.left + selectedIdea.width / 2);\r\n        const arrowRotationStart =\r\n          (180 / Math.PI) * Math.atan2(arrowHeight, arrowWidth);\r\n        const arrowRotationEnd =\r\n          arrowRotationStart - 180 * Math.sign(arrowRotationStart);\r\n        return (\r\n          <Arrow\r\n            key={`${selectedId} -> ${endId}`}\r\n            start={calcCoords(selectedIdea, arrowRotationStart)}\r\n            end={calcCoords(ideas[endId], arrowRotationEnd)}\r\n          />\r\n        );\r\n      })}\r\n      {linkingState && (\r\n        <div className=\"linkingArrow\">\r\n          <Arrow\r\n            start={[selectedIdea.top, selectedIdea.left]}\r\n            end={linkerEnd}\r\n          />\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default FreeFormIdeas;\r\n"]},"metadata":{},"sourceType":"module"}